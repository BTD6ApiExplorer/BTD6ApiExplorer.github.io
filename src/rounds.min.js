let roundPreviewFilterType,canvas,ctx,currentRoundsetView="Simple",roundsetProcessed=null,selectedRoundset=null,currentPreviewRound=0,currentIndexInModifiedRounds=0,previewActive=!1,previewModified=null,currentModifiedRounds=[],currentRoundsetEndRound=140,hiddenGroups=[];function generateRoundsets(){let e=document.getElementById("rounds-content");e.innerHTML="";let t=document.createElement("div");t.classList.add("progress-page"),e.appendChild(t);let n=document.createElement("div");n.classList.add("selectors-div"),t.appendChild(n);let d={},o={};Object.entries(constants.limitedTimeEvents).forEach((([e,t])=>{t.end>Date.now()?d[e]=t:o[e]=t})),Object.entries(d).forEach((([e,t])=>{let d=document.createElement("div");d.classList.add("roundset-selector-div"),d.addEventListener("click",(()=>{showLoading(),showRoundsetModel("rounds",t.roundset)})),n.appendChild(d);let o=document.createElement("img");switch(o.classList.add("roundset-selector-img"),d.appendChild(o),t.type){case"Race":o.src="../Assets/UI/EventRaceBtn.webp",d.classList.add("race-roundset");break;case"Odyssey":o.src="../Assets/UI/OdysseyEventBtn.webp",d.classList.add("odyssey-roundset");break;case"Boss":o.src=`../Assets/BossIcon/${t.boss[0].toUpperCase()+t.boss.slice(1)}EventIcon.webp`,d.classList.add("boss-roundset")}let s=document.createElement("div");s.classList.add("roundset-selector-text-div"),d.appendChild(s);let a=document.createElement("p");a.classList.add("selector-text","black-outline"),a.innerHTML=`${t.type} Event - ${e}`,s.appendChild(a);let r=document.createElement("p");r.id="time-left-"+e,r.classList.add("selector-text","black-outline"),s.appendChild(r),new Date<new Date(t.start)?r.innerHTML="Coming Soon!":new Date(t.end)>new Date&&(updateTimer(new Date(t.end),r.id),timerInterval=setInterval((()=>updateTimer(new Date(t.end),r.id)),1e3));let i=document.createElement("img");i.classList.add("selector-go-img"),i.src="../Assets/UI/ContinueBtn.webp",d.appendChild(i)}));let s=Object.fromEntries(Object.entries(constants.roundSets).filter((([e,t])=>"normal"===t.type))),a=Object.fromEntries(Object.entries(constants.roundSets).filter((([e,t])=>"boss"===t.type))),r=Object.fromEntries(Object.entries(constants.roundSets).filter((([e,t])=>"legends"===t.type))),i=Object.fromEntries(Object.entries(constants.roundSets).filter((([e,t])=>"quest"===t.type)));Object.entries(s).forEach((([e,t])=>{let d=document.createElement("div");d.classList.add("roundset-selector-div","wood-container"),d.addEventListener("click",(()=>{showLoading(),showRoundsetModel("rounds",e)})),n.appendChild(d);let o=document.createElement("img");o.classList.add("roundset-selector-img"),o.src=`../Assets/UI/${t.icon}.webp`,d.appendChild(o);let s=document.createElement("p");s.classList.add("selector-text","black-outline"),s.innerHTML=t.name,d.appendChild(s);let a=document.createElement("img");a.classList.add("selector-go-img"),a.src="../Assets/UI/ContinueBtn.webp",d.appendChild(a)})),Object.entries(r).forEach((([e,t])=>{let d=document.createElement("div");d.classList.add("roundset-selector-div","veteran-container"),d.addEventListener("click",(()=>{showLoading(),showRoundsetModel("rounds",e)})),n.appendChild(d);let o=document.createElement("img");o.classList.add("roundset-selector-img"),o.src=`../Assets/UI/${t.icon}.webp`,d.appendChild(o);let s=document.createElement("p");s.classList.add("selector-text","black-outline"),s.innerHTML=t.name,d.appendChild(s);let a=document.createElement("img");a.classList.add("selector-go-img"),a.src="../Assets/UI/ContinueBtn.webp",d.appendChild(a)}));let l=document.createElement("p");l.classList.add("other-roundsets-selector-text","black-outline"),l.innerHTML="Boss Custom Rounds",n.appendChild(l);let c=document.createElement("div");c.classList.add("other-roundsets-selector-div"),n.appendChild(c),Object.entries(a).forEach((([e,t])=>{let n=document.createElement("div");n.classList.add("other-roundset-selector-div"),n.addEventListener("click",(()=>{showRoundsetModel("rounds",e)})),c.appendChild(n);let d=document.createElement("img");d.classList.add("other-roundset-selector-img"),d.src=`../Assets/UI/${t.icon}.webp`,n.appendChild(d)}));let u=document.createElement("p");u.classList.add("other-roundsets-selector-text","black-outline"),u.innerHTML="Quest Custom Rounds",n.appendChild(u);let p=document.createElement("div");p.classList.add("other-roundsets-selector-div"),n.appendChild(p),Object.entries(i).forEach((([e,t])=>{let n=document.createElement("div");n.classList.add("other-roundset-selector-div"),n.addEventListener("click",(()=>{showRoundsetModel("rounds",e)})),p.appendChild(n);let d=document.createElement("p");d.classList.add("other-roundset-selector-text","black-outline");let o=e.match(/(Part|Stage)(\d+)/i);null!=o&&(d.innerHTML=`${o[1]} ${o[2]}`,n.appendChild(d));let s=document.createElement("img");s.classList.add("other-roundset-selector-img"),s.src=`../Assets/QuestIcon/${t.icon}.webp`,n.appendChild(s)}));let m=document.createElement("div");m.classList.add("known-previous-events-div"),n.appendChild(m);let h=document.createElement("p");h.classList.add("other-roundsets-selector-text","black-outline"),h.innerHTML="Known Previous Events",m.appendChild(h),Object.entries(o).forEach((([e,t])=>{let d=document.createElement("div");d.classList.add("roundset-selector-div"),d.addEventListener("click",(()=>{showLoading(),showRoundsetModel("rounds",t.roundset)})),n.appendChild(d);let o=document.createElement("img");switch(o.classList.add("roundset-selector-img"),d.appendChild(o),t.type){case"Race":o.src="../Assets/UI/EventRaceBtn.webp",d.classList.add("race-roundset");break;case"Odyssey":o.src="../Assets/UI/OdysseyEventBtn.webp",d.classList.add("odyssey-roundset");break;case"Boss":o.src=`../Assets/BossIcon/${t.boss[0].toUpperCase()+t.boss.slice(1)}EventIcon.webp`,d.style.backgroundImage=`url(../Assets/EventBanner/EventBannerSmall${t.boss[0].toUpperCase()+t.boss.slice(1)}.webp)`,d.classList.add("boss-roundset")}let s=document.createElement("div");s.classList.add("roundset-selector-text-div"),d.appendChild(s);let a=document.createElement("p");a.classList.add("selector-text","black-outline"),a.innerHTML=`${t.type} Event - ${e}`,s.appendChild(a);let r=document.createElement("p");r.id="time-left-"+e,r.classList.add("selector-text","black-outline"),s.appendChild(r),new Date<new Date(t.start)?r.innerHTML="Coming Soon!":new Date(t.end)>new Date?(updateTimer(new Date(t.end),r.id),timerInterval=setInterval((()=>updateTimer(new Date(t.end),r.id)),1e3)):r.innerHTML=`${new Date(t.start).toLocaleDateString()} - ${new Date(t.end).toLocaleDateString()}`;let i=document.createElement("img");i.classList.add("selector-go-img"),i.src="../Assets/UI/ContinueBtn.webp",d.appendChild(i)}));let g=document.createElement("div");g.classList.add("sku-roundset-selector-div"),n.appendChild(g);let v=document.createElement("p");v.classList.add("other-roundsets-selector-text","black-outline"),v.innerHTML="Other Custom Rounds",g.appendChild(v);let w=document.createElement("p");w.classList.add("sku-roundset-selector-desc"),w.innerHTML="These mostly old roundsets will have only been used in one-off events such as Odysseys, Races, or Bosses and may not have ended up being used for their intended purpose despite their name. Take these roundsets with a grain of salt. I'm including them on the viewer for completeness sake.",g.appendChild(w);let b=document.createElement("div");b.classList.add("sku-roundsets-selector-div"),g.appendChild(b),constants.skuRoundsets.forEach((e=>{let t=document.createElement("div");t.classList.add("sku-roundset-selector-div"),t.addEventListener("click",(()=>{showRoundsetModel("rounds",e)})),b.appendChild(t);let n=document.createElement("p");n.classList.add("sku-roundset-selector-text","black-outline"),n.innerHTML=e,t.appendChild(n)}))}async function showRoundsetModel(e,t){let n=document.getElementById("roundsets-content");n.style.display="flex",n.innerHTML="",document.getElementById(`${e}-content`).style.display="none",addToBackQueue({source:e,destination:"roundsets"}),resetScroll();let d=await fetch(`./data/${t}.json`).then((e=>e.json())),o="unknown";constants.roundSets[t]&&(o=constants.roundSets[t].type),roundsetProcessed=addRoundHints(t,d),selectedRoundset=t;let s=document.createElement("div");s.classList.add("roundset-header-bar"),n.appendChild(s);let a=document.createElement("div");a.classList.add("roundset-header-title"),s.appendChild(a);let r=document.createElement("div");r.classList.add("roundset-header-left"),a.appendChild(r);let i=document.createElement("p");i.classList.add("roundset-header-text","black-outline"),i.innerHTML=constants.roundSets[t]?constants.roundSets[t].name:t,a.appendChild(i);let l=document.createElement("div");l.classList.add("roundset-header-right"),a.appendChild(l);let c=document.createElement("img");if(c.classList.add("modal-close"),c.src="./Assets/UI/CloseBtn.webp",c.addEventListener("click",(()=>{goBack()})),l.appendChild(c),t.startsWith("Rogue")){let n=document.createElement("div");n.classList.add("d-flex","jc-evenly"),s.appendChild(n);let d={RogueRoundSet:"Rogue Legends Default Roundset",RogueBloonierSet:"Now with more Bloons!",RogueDenseSet:"Bloons spawn more densely",RoguePinkSet:"Bloons start fast and end slow",RoguePurpleSet:"More Purples and faster Bloons. Bloon health is reduced",RogueImmuneSet:"Alternate rounds with more Bloons with immunities",RogueLeadSet:"More Lead Bloons and DDTs"};Object.entries(d).forEach((([d,o])=>{let s=document.createElement("div");s.classList.add("pointer"),s.addEventListener("click",(()=>{showLoading(),goBack(),showRoundsetModel(e,d)})),n.appendChild(s),d==t&&s.classList.add("rogue-roundset-selector-active");let a=document.createElement("img");a.classList.add("roundset-header-rogue-img"),a.style.width="100px",a.src=`../Assets/UI/${d}.webp`,s.appendChild(a),tippy(s,{content:o,placement:"top",theme:"speech_bubble",popperOptions:{modifiers:[{name:"preventOverflow",options:{boundary:"viewport",padding:{right:18}}}]}})}))}let u=document.createElement("div");u.classList.add("roundset-header-bar-bottom"),s.appendChild(u);let p=document.createElement("div");p.classList.add("maps-progress-views"),u.appendChild(p);let m=document.createElement("p");m.classList.add("maps-progress-coop-toggle-text","maps-progress-view-list","black-outline"),m.innerHTML="Display Type:",p.appendChild(m);let h=document.createElement("div");h.classList.add("maps-progress-view","stats-tab-yellow","black-outline"),h.innerHTML="Simple",p.appendChild(h);let g=document.createElement("div");g.classList.add("maps-progress-view","black-outline"),g.innerHTML="Detailed",p.appendChild(g);let v=document.createElement("div");v.classList.add("maps-progress-view","black-outline"),v.innerHTML="Preview",p.appendChild(v);let w=document.createElement("div");w.classList.add("maps-progress-filter"),u.appendChild(w);let b=document.createElement("div");b.classList.add("map-progress-filter-difficulty");let L=document.createElement("p");L.classList.add("maps-progress-coop-toggle-text","black-outline"),b.appendChild(L);let y=document.createElement("input");y.id="roundset-modified-checkbox",y.classList.add("maps-progress-coop-toggle-input"),y.type="checkbox",b.appendChild(y),"boss"==o?(currentModifiedRounds=[],roundsetProcessed.rounds.forEach(((e,t)=>{e.hasOwnProperty("modified")&&currentModifiedRounds.push(e.roundNumber)})),y.checked=!0,w.appendChild(b),L.innerHTML="Only Modified:",roundPreviewFilterType="modified",previewModified=y):"quest"==o?(currentModifiedRounds=[],roundsetProcessed.rounds.forEach(((e,n)=>{e.roundNumber>constants.roundSets[t].endRound||currentModifiedRounds.push(e.roundNumber)})),L.innerHTML="Hide Unused:",roundPreviewFilterType="unused",currentRoundsetEndRound=constants.roundSets[t].endRound,w.appendChild(b),y.checked=!0,previewModified=y):previewModified=null;let f=document.createElement("div");f.classList.add("maps-progress-coop-toggle"),w.appendChild(f);let E=document.createElement("p");E.classList.add("maps-progress-coop-toggle-text","black-outline"),E.innerHTML="Reverse:",f.appendChild(E);let C=document.createElement("input");C.id="roundset-reverse-checkbox",C.classList.add("maps-progress-coop-toggle-input"),C.type="checkbox",f.appendChild(C);let k=document.createElement("div");k.id="roundset-content",k.classList.add("rounds-content"),n.appendChild(k),h.addEventListener("click",(()=>{h.classList.add("stats-tab-yellow"),g.classList.remove("stats-tab-yellow"),v.classList.remove("stats-tab-yellow"),currentRoundsetView="Simple",generateRounds(currentRoundsetView,C.checked,y.checked)})),g.addEventListener("click",(()=>{g.classList.add("stats-tab-yellow"),h.classList.remove("stats-tab-yellow"),v.classList.remove("stats-tab-yellow"),currentRoundsetView="Topper",generateRounds(currentRoundsetView,C.checked,y.checked)})),v.addEventListener("click",(()=>{v.classList.add("stats-tab-yellow"),h.classList.remove("stats-tab-yellow"),g.classList.remove("stats-tab-yellow"),currentRoundsetView="Preview",generateRounds(currentRoundsetView,C.checked,y.checked)})),C.addEventListener("change",(()=>{onChangeReverse(C.checked)})),y.addEventListener("change",(()=>{onChangeModified(y.checked)})),currentPreviewRound=0,currentRoundsetView="Simple",generateRounds(currentRoundsetView,C.checked,y.checked),onChangeModified(y.checked)}function processRoundset(e,t){return null!=t&&t.rounds.forEach(((t,n)=>{let d=e.rounds.findIndex((e=>e.roundNumber==t.roundNumber));t.addToRound?-1!=d&&(e.rounds[d].bloonGroups=e.rounds[d].bloonGroups.concat(t.bloonGroups),e.rounds[d].addToRound=!0):-1!=d&&(e.rounds[d]=t)})),e}function addRoundHints(e,t){return["DefaultRoundSet","AlternateRoundSet","RogueRoundSet"].includes(e)&&t.rounds.forEach(((t,n)=>{switch(e){case"DefaultRoundSet":constants.roundHints.hasOwnProperty("Hint "+(t.roundNumber-1))&&(t.hint=constants.roundHints["Hint "+(t.roundNumber-1)]);break;case"AlternateRoundSet":constants.roundHints.hasOwnProperty("Alternate Hint "+(t.roundNumber-1))&&(t.hint=constants.roundHints["Alternate Hint "+(t.roundNumber-1)]);break;case"RogueRoundSet":constants.roundHints.hasOwnProperty("Rogue Hint "+(t.roundNumber-1))&&(t.hint=constants.roundHints["Rogue Hint "+(t.roundNumber-1)])}})),t}async function generateRounds(e,t,n){let d=document.getElementById("roundset-content");d.innerHTML="";let o=!0,s=[];roundsetProcessed.rounds.forEach(((e,t)=>{s.push(e.roundNumber)}));for(let e=0;e<s.length;e++)if(s[e]!=e+1){o=!1;break}switch(e){case"Simple":resetPreview();let e=!1;roundsetProcessed.rounds.forEach((async(t,n)=>{let o=document.createElement("div");o.id=`round-${t.roundNumber}`,o.classList.add("round-div","jc-between"),e&&o.classList.add("round-div-alt");let s=document.createElement("p");s.classList.add("round-number","black-outline"),s.innerHTML=t.roundNumber,o.appendChild(s);let a=document.createElement("div");a.id=`round-${t.roundNumber}-groups`,a.classList.add("round-bloon-groups","fg-1"),o.appendChild(a);let r=document.createDocumentFragment();t.bloonGroups.sort(((e,t)=>e.start-t.start)).forEach(((e,t)=>{let n=document.createElement("div");n.classList.add("bloon-group-div");let d=document.createElement("p");d.classList.add("bloon-group-number","black-outline"),d.innerHTML="x"+e.count,n.appendChild(d);let o=document.createElement("img");o.classList.add("bloon-group-bloon"),o.src=`../Assets/BloonIcon/${e.bloon}.webp`,o.loading="lazy",n.appendChild(o),r.appendChild(n)})),a.appendChild(r);let i=document.createElement("div");i.classList.add("d-flex","ai-center"),i.style.minWidth="120px",o.appendChild(i);let l=document.createElement("img");l.classList.add("leaderboard-entry-score-icon"),l.src="./Assets/UI/StopWatch.webp",i.appendChild(l);let c=document.createElement("p");c.classList.add("round-number","black-outline");let u=t.bloonGroups.length?Math.max(...t.bloonGroups.map((e=>e.end))):0;c.innerHTML=u.toFixed(2),i.appendChild(c),d.appendChild(o),e=!e})),document.getElementById("roundset-reverse-checkbox").checked&&onChangeReverse(),null!=previewModified&&previewModified.checked&&onChangeModified(!0);break;case"Topper":resetPreview();let n=document.createElement("div");n.classList.add("rounds-detailed-div"),d.appendChild(n),copyLoadingIcon(n),setTimeout((()=>{let e=document.createDocumentFragment(),d=document.createElement("div");d.classList.add("disclaimer-div"),e.appendChild(d);let s=document.createElement("p");s.classList.add("disclaimer"),s.innerHTML="This layout is based on Topper's website:",d.appendChild(s);let a=document.createElement("a");a.classList.add("disclaimer-link"),a.href="https://topper64.co.uk/nk/btd6/rounds/",a.target="_blank",a.innerHTML="Topper's Round Information",d.appendChild(a);roundsetProcessed.rounds.forEach((async(n,d)=>{let s=document.createElement("div");s.id=`round-${n.roundNumber}`,s.classList.add("round-div-detailed"),t&&s.classList.add("round-div-reverse");let a=document.createElement("div");a.classList.add("rounds-div-header"),s.appendChild(a);let r=document.createElement("p");r.classList.add("round-number","round-number-detailed","black-outline"),r.innerHTML=`Round ${n.roundNumber}`,a.appendChild(r);let i=document.createElement("div");i.classList.add("income-div"),a.appendChild(i);let l=document.createElement("img");l.classList.add("income-img"),l.src="../Assets/UI/CoinIcon.webp",i.appendChild(l);let c=document.createElement("div");c.classList.add("income-text-div"),i.appendChild(c);let u=document.createElement("p");u.classList.add("round-income","black-outline"),u.innerHTML=`Income: ${n.income.toLocaleString()}`,c.appendChild(u);let p=document.createElement("p");p.classList.add("round-income-total","black-outline"),p.innerHTML=`Total: ${n.incomeSum.toLocaleString()}`,o&&c.appendChild(p);let m=document.createElement("div");m.classList.add("rbe-div"),a.appendChild(m);let h=document.createElement("img");h.classList.add("rbe-img"),h.src="../Assets/BloonIcon/Red.webp",m.appendChild(h);let g=document.createElement("div");g.classList.add("rbe-text-div"),m.appendChild(g);let v=document.createElement("p");v.classList.add("round-rbe","black-outline"),v.innerHTML=`RBE: ${n.rbe.toLocaleString()}`,g.appendChild(v);let w=document.createElement("p");w.classList.add("round-rbe-total","black-outline"),w.innerHTML=`Total: ${n.rbeSum.toLocaleString()}`,o&&g.appendChild(w);let b=n.bloonGroups.length?Math.max(...n.bloonGroups.map((e=>e.end))):0,L=document.createElement("p");if(L.classList.add("round-duration","black-outline"),L.innerHTML=`Duration: ${b.toFixed(2)}s`,a.appendChild(L),n.hint){let e=document.createElement("div");e.classList.add("round-hint-div","coop-border"),s.appendChild(e);let t=document.createElement("p");t.classList.add("round-hint-x"),t.innerHTML="X",t.addEventListener("click",(()=>{e.style.display="none"})),e.appendChild(t);let d=document.createElement("p");d.classList.add("round-hint"),d.innerHTML=n.hint,e.appendChild(d)}let y=document.createElement("div");y.classList.add("timeline-div"),s.appendChild(y),n.bloonGroups.forEach(((e,t)=>{let n=document.createElement("div");n.classList.add("bloon-group-div-detailed"),y.appendChild(n);let d=document.createElement("div");d.classList.add("left-div"),n.appendChild(d);let o=document.createElement("img");o.classList.add("bloon-image"),o.src=`../Assets/BloonIcon/${e.bloon}.webp`,d.appendChild(o);let s=document.createElement("p");s.classList.add("bloon-count","black-outline"),s.innerHTML="x"+e.count,d.appendChild(s);let a=document.createElement("div");a.classList.add("timeline-right-div"),n.appendChild(a);let r=document.createElement("div");r.classList.add("bloon-bar"),a.appendChild(r);let i=document.createElement("div");i.classList.add("bloon-bar-fill"),i.style.background=bloonsData[e.bloon.replace("Camo","").replace("Regrow","").replace("Fortified","")].color,e.bloon.includes("Rainbow")||(i.style.border=`4px solid ${bloonsData[e.bloon.replace("Camo","").replace("Regrow","").replace("Fortified","")].border}`);let l=(e.end-e.start)/b*100,c=e.start/b*100;l<5&&(l=5),c+l>100&&(c=100-l),i.style.width=`${l}%`,i.style.left=`${c}%`,r.appendChild(i)})),e.appendChild(s)})),n.innerHTML="",n.appendChild(e),document.getElementById("roundset-reverse-checkbox").checked&&onChangeReverse(),null!=previewModified&&previewModified.checked&&onChangeModified(!0)}),0);break;case"Preview":resetPreview();let s=document.createElement("div");s.classList.add("preview-container-div"),d.appendChild(s);let a=document.createElement("div");a.classList.add("preview-div"),s.appendChild(a);let r=document.createElement("div");r.classList.add("preview-header"),a.appendChild(r);let i=document.createElement("p");i.id="round-number-preview",i.classList.add("round-number","round-number-preview","black-outline"),i.innerHTML=`Round ${roundsetProcessed.rounds[currentPreviewRound].roundNumber}`,r.appendChild(i);let l=document.createElement("input");l.id="select-round-num-preview",l.classList.add("select-round-num"),l.type="number",l.min=1,l.max=roundsetProcessed.rounds.length,l.value=currentPreviewRound+1,l.addEventListener("change",(()=>{l.value<1&&(l.value=1),l.value>roundsetProcessed.rounds.length&&(l.value=roundsetProcessed.rounds.length),i.innerHTML=`Round ${roundsetProcessed.rounds[currentPreviewRound].roundNumber}`,currentPreviewRound=l.value-1,updatePreviewRoundTimeline()})),r.appendChild(l);let c=document.createElement("div");c.classList.add("preview-right-div"),r.appendChild(c);let u=document.createElement("img");u.classList.add("clear-button"),u.src="../Assets/UI/DestroyBloonsBtn.webp",u.addEventListener("click",(()=>{clearPreview()})),c.appendChild(u);let p=document.createElement("img");p.classList.add("play-normal-button"),p.src="../Assets/UI/GoBtnSmall.webp",p.addEventListener("click",(()=>{speedMultiplier=1,i.innerHTML=`Round ${roundsetProcessed.rounds[currentPreviewRound].roundNumber}`,clearPreview(),startRound(roundsetProcessed.rounds[currentPreviewRound])})),c.appendChild(p);let m=document.createElement("img");m.classList.add("play-fast-button"),m.src="../Assets/UI/FastForwardBtn.webp",m.addEventListener("click",(()=>{speedMultiplier=3,i.innerHTML=`Round ${roundsetProcessed.rounds[currentPreviewRound].roundNumber}`,clearPreview(),startRound(roundsetProcessed.rounds[currentPreviewRound])})),c.appendChild(m),canvas=document.createElement("canvas"),canvas.classList.add("roundset-canvas"),canvas.width=800,canvas.height=300,a.appendChild(canvas);let h=document.createElement("div");h.classList.add("preview-footer-div"),a.appendChild(h);let g=document.createElement("div");g.classList.add("difficulty-div"),h.appendChild(g);let v=document.createElement("div");v.classList.add("maps-progress-view","stats-tab-yellow","black-outline"),v.innerHTML="Easy",g.appendChild(v);let w=document.createElement("div");w.classList.add("maps-progress-view","black-outline"),w.innerHTML="Medium",g.appendChild(w);let b=document.createElement("div");switch(b.classList.add("maps-progress-view","black-outline"),b.innerHTML="Hard",g.appendChild(b),v.addEventListener("click",(()=>{difficultySpeedModifier=1,v.classList.add("stats-tab-yellow"),w.classList.remove("stats-tab-yellow"),b.classList.remove("stats-tab-yellow")})),w.addEventListener("click",(()=>{difficultySpeedModifier=1.1,v.classList.remove("stats-tab-yellow"),w.classList.add("stats-tab-yellow"),b.classList.remove("stats-tab-yellow")})),b.addEventListener("click",(()=>{difficultySpeedModifier=1.26,v.classList.remove("stats-tab-yellow"),w.classList.remove("stats-tab-yellow"),b.classList.add("stats-tab-yellow")})),selectedRoundset){case"AlternateRoundSet":b.click();break;case"AcceleratedRoundSet":case"EnduranceRoundSet":case"FastUpgradesRoundSet":case"MOABMadnessRoundSet":case"RogueRoundSet":case"RogueBloonierSet":case"RogueDenseSet":case"RoguePinkSet":case"RoguePurpleSet":case"RogueImmuneSet":case"RogueLeadSet":w.click()}let L=document.createElement("div");L.classList.add("next-prev-div"),h.appendChild(L);let y=document.createElement("div");y.classList.add("maps-progress-view","black-outline"),y.innerHTML="Previous",y.addEventListener("click",(()=>{null!=previewModified&&previewModified.checked?(currentIndexInModifiedRounds--,currentIndexInModifiedRounds<0&&(currentIndexInModifiedRounds=currentModifiedRounds.length-1),currentPreviewRound=currentModifiedRounds[currentIndexInModifiedRounds]-1):(currentPreviewRound--,currentPreviewRound<0&&(currentPreviewRound=roundsetProcessed.rounds.length-1)),l.value=currentPreviewRound+1,clearPreview(),updatePreviewRoundTimeline()})),L.appendChild(y);let f=document.createElement("div");f.classList.add("maps-progress-view","black-outline"),f.innerHTML="Next",f.addEventListener("click",(()=>{null!=previewModified&&previewModified.checked?(currentIndexInModifiedRounds++,currentIndexInModifiedRounds>=currentModifiedRounds.length&&(currentIndexInModifiedRounds=0),currentPreviewRound=currentModifiedRounds[currentIndexInModifiedRounds]-1):(currentPreviewRound++,currentPreviewRound>=roundsetProcessed.rounds.length&&(currentPreviewRound=0)),l.value=currentPreviewRound+1,clearPreview(),updatePreviewRoundTimeline()})),L.appendChild(f);let E=document.createElement("div");E.id="preview-round-info-div",E.classList.add("round-info-div"),a.appendChild(E),ctx=canvas.getContext("2d");let C=performance.now();previewActive=!0,requestAnimationFrame((function e(){if(!previewActive)return;const t=performance.now(),n=(t-C)/1e3;C=t,update(n),render(),requestAnimationFrame(e)})),null!=previewModified&&previewModified.checked&&onChangeModified(!0),updatePreviewRoundTimeline(),document.getElementById("roundset-reverse-checkbox").checked&&onChangeReverse()}}function onChangeModified(e){switch(currentRoundsetView){case"Simple":let t=!1;roundsetProcessed.rounds.forEach((async(n,d)=>{let o=document.getElementById(`round-${n.roundNumber}`);e&&"modified"===roundPreviewFilterType&&!n.hasOwnProperty("modified")||e&&"unused"===roundPreviewFilterType&&n.roundNumber>currentRoundsetEndRound?o.style.display="none":(o.style.display="flex",t?o.classList.add("round-div-alt"):Array.from(o.classList).includes("round-div-alt")&&o.classList.remove("round-div-alt"),t=!t)}));break;case"Topper":roundsetProcessed.rounds.forEach((async(t,n)=>{let d=document.getElementById(`round-${t.roundNumber}`);e&&"modified"===roundPreviewFilterType&&!t.hasOwnProperty("modified")||e&&"unused"===roundPreviewFilterType&&t.roundNumber>currentRoundsetEndRound?d.style.display="none":d.style.display="flex"}));break;case"Preview":switch(roundPreviewFilterType){case"modified":e?(currentIndexInModifiedRounds=0,currentPreviewRound=currentModifiedRounds[0]-1,document.getElementById("round-number-preview").innerHTML=`Round ${currentModifiedRounds[0]}`,document.getElementById("select-round-num-preview").value=currentModifiedRounds[0],updatePreviewRoundTimeline()):(currentPreviewRound=0,document.getElementById("round-number-preview").innerHTML=`Round ${currentPreviewRound+1}`,document.getElementById("select-round-num-preview").value=currentPreviewRound+1,updatePreviewRoundTimeline());break;case"unused":e?currentRoundsetEndRound<currentPreviewRound+1&&(currentPreviewRound=0,document.getElementById("round-number-preview").innerHTML=`Round ${currentPreviewRound+1}`,document.getElementById("select-round-num-preview").value=currentPreviewRound+1,updatePreviewRoundTimeline()):(currentPreviewRound=0,document.getElementById("round-number-preview").innerHTML=`Round ${currentPreviewRound+1}`,document.getElementById("select-round-num-preview").value=currentPreviewRound+1,updatePreviewRoundTimeline())}}}function onChangeReverse(){switch(currentRoundsetView){case"Simple":roundsetProcessed.rounds.forEach(((e,t)=>{let n=document.getElementById(`round-${e.roundNumber}-groups`);Array.from(n.children).reverse().forEach((e=>n.appendChild(e)))}));break;case"Topper":let e=document.getElementsByClassName("timeline-div");for(let t of e)t.classList.toggle("timeline-div-reverse");let t=document.getElementsByClassName("timeline-right-div");for(let e of t)e.classList.toggle("flip-horizontal");break;case"Preview":document.getElementById("preview-timeline-div").classList.toggle("timeline-div-reverse");let n=document.getElementsByClassName("preview-timeline-right-div");for(let e of n)e.classList.toggle("flip-horizontal")}clearPreview()}function updatePreviewRoundTimeline(){let e=document.getElementById("preview-round-info-div");e.innerHTML="";let t=roundsetProcessed.rounds[currentPreviewRound];hiddenGroups=[];let n=document.createElement("div");n.classList.add("round-div-detailed"),e.appendChild(n);let d=document.createElement("div");d.classList.add("rounds-div-header"),n.appendChild(d);let o=document.createElement("p");o.classList.add("round-number","round-number-detailed","black-outline"),o.innerHTML=`Round ${t.roundNumber}`,d.appendChild(o);let s=document.createElement("div");s.classList.add("income-div"),d.appendChild(s);let a=document.createElement("img");a.classList.add("income-img"),a.src="../Assets/UI/CoinIcon.webp",s.appendChild(a);let r=document.createElement("div");r.classList.add("income-text-div"),s.appendChild(r);let i=document.createElement("p");i.classList.add("round-income","black-outline"),i.innerHTML=`Income: ${t.income.toLocaleString()}`,r.appendChild(i);let l=document.createElement("p");l.classList.add("round-income-total","black-outline"),l.innerHTML=`Total: ${t.incomeSum.toLocaleString()}`,r.appendChild(l);let c=document.createElement("div");c.classList.add("rbe-div"),d.appendChild(c);let u=document.createElement("img");u.classList.add("rbe-img"),u.src="../Assets/BloonIcon/Red.webp",c.appendChild(u);let p=document.createElement("div");p.classList.add("rbe-text-div"),c.appendChild(p);let m=document.createElement("p");m.classList.add("round-rbe","black-outline"),m.innerHTML=`RBE: ${t.rbe.toLocaleString()}`,p.appendChild(m);let h=document.createElement("p");h.classList.add("round-rbe-total","black-outline"),h.innerHTML=`Total: ${t.rbeSum.toLocaleString()}`,p.appendChild(h);let g=t.bloonGroups.length?Math.max(...t.bloonGroups.map((e=>e.end))):0,v=document.createElement("p");if(v.classList.add("round-duration","black-outline"),v.innerHTML=`Duration: ${g.toFixed(2)}s`,d.appendChild(v),t.hint){let e=document.createElement("div");e.classList.add("round-hint-div","coop-border"),n.appendChild(e);let d=document.createElement("p");d.classList.add("round-hint-x"),d.innerHTML="X",d.addEventListener("click",(()=>{e.style.display="none"})),e.appendChild(d);let o=document.createElement("p");o.classList.add("round-hint"),o.innerHTML=t.hint,e.appendChild(o)}let w=document.createElement("div");w.id="preview-timeline-div",w.classList.add("timeline-div"),n.appendChild(w);t.bloonGroups.forEach(((e,t)=>{let n=document.createElement("div");n.classList.add("bloon-group-div-detailed"),n.addEventListener("click",(()=>{hiddenGroups.includes(t)?(n.style.filter="",hiddenGroups.splice(hiddenGroups.indexOf(t),1)):(hiddenGroups.push(t),n.style.filter="brightness(0.5)")})),w.appendChild(n);let d=document.createElement("div");d.classList.add("left-div"),n.appendChild(d);let o=document.createElement("img");o.classList.add("bloon-image"),o.src=`../Assets/BloonIcon/${e.bloon}.webp`,d.appendChild(o);let s=document.createElement("p");s.classList.add("bloon-count","black-outline"),s.innerHTML="x"+e.count,d.appendChild(s);let a=document.createElement("div");a.classList.add("timeline-right-div","preview-timeline-right-div"),n.appendChild(a);let r=document.createElement("div");r.classList.add("bloon-bar"),a.appendChild(r);let i=document.createElement("div");i.classList.add("bloon-bar-fill"),i.style.background=bloonsData[e.bloon.replace("Camo","").replace("Regrow","").replace("Fortified","")].color,e.bloon.includes("Rainbow")||(i.style.border=`4px solid ${bloonsData[e.bloon.replace("Camo","").replace("Regrow","").replace("Fortified","")].border}`);let l=(e.end-e.start)/g*100,c=e.start/g*100;l<5&&(l=5),c+l>100&&(c=100-l),i.style.width=`${l}%`,i.style.left=`${c}%`,r.appendChild(i)})),document.getElementById("roundset-reverse-checkbox").checked&&onChangeReverse()}function addTimelinePlayhead(e){let t=document.getElementById("preview-timeline-div"),n=document.createElement("div");n.id="preview-playhead",n.classList.add("playhead"),t.appendChild(n),n.style.animation=`playhead ${e}s linear`,n.addEventListener("animationend",(function(){n.remove()}))}function clearPreview(){document.getElementById("preview-playhead")&&document.getElementById("preview-playhead").remove(),currentRoundGroups=null,bloons.length=0}function resetPreview(){previewActive=!1,clearPreview()}let speedMultiplier=1,bloonsData={Red:{name:"Red",rbe:1,speed:25,layer:1,scale:.8,color:"#ED0F0F",border:"#690000"},Blue:{name:"Blue",rbe:2,speed:35,layer:2,scale:.85,color:"#2797E0",border:"#004772"},Green:{name:"Green",rbe:3,speed:45,layer:3,scale:.9,color:"#77A80F",border:"#3D5400"},Yellow:{name:"Yellow",rbe:4,speed:80,layer:4,scale:.95,color:"#FFD50F",border:"#8E620C"},Pink:{name:"Pink",rbe:5,speed:87.5,layer:5,scale:1,color:"#F15060",border:"#A92626"},Black:{name:"Black",rbe:11,speed:45,layer:6,scale:.58,color:"#161616",border:"#414141"},Purple:{name:"Purple",rbe:11,speed:75,layer:7,scale:.95,color:"#9326E0",border:"#00E4FF"},White:{name:"White",rbe:12,speed:50,layer:6,scale:.58,color:"#D7D7D7",border:"#727272"},Lead:{name:"Lead",rbe:23,speed:25,layer:7,scale:.95,color:"#7E7E7E",border:"#2F2F2F"},Zebra:{name:"Zebra",rbe:23,speed:45,layer:7,scale:.9,color:"repeating-linear-gradient(145deg, #040404, #040404 10px, #ffffff 10px, #ffffff 20px)",border:"#5A5A5A"},Rainbow:{name:"Rainbow",rbe:47,speed:55,layer:8,scale:1,color:"linear-gradient(180deg, rgba(228,26,26,1) 0%, rgba(255,159,0,1) 16%, rgba(255,224,0,1) 33%, rgba(125,181,4,1) 48%, rgba(83,176,222,1) 66%, rgba(226,74,226,1) 84%, rgba(132,21,132,1) 100%)",border:"transparent"},Ceramic:{name:"Ceramic",rbe:47,speed:62.5,layer:9,scale:1,color:"#BE6C1D",border:"#61370B"},Moab:{name:"Moab",rbe:616,speed:25,layer:10,color:"#2AC2FF",border:"#FFFFFF"},Bfb:{name:"Bfb",rbe:3164,speed:6.25,layer:11,color:"#C00505",border:"#FFFFFF"},Zomg:{name:"Zomg",rbe:16656,speed:4.5,layer:12,color:"#575757",border:"#B7F700"},Ddt:{name:"Ddt",rbe:3164,speed:66,layer:12,color:"#3C3C3C",border:"#A5A5A5"},Bad:{name:"Bad",rbe:16464,speed:4.5,layer:13,color:"#AB02AC",border:"#500151"}},bloons_spritesheet=new Image;bloons_spritesheet.src="../Assets/BloonIcon/preview_bloons_spritesheet.webp";let bloonImageMap={CeramicCamo:{x:1153,y:0,width:129,height:163},CeramicFortified:{x:993,y:547,width:140,height:163},CeramicFortifiedCamo:{x:993,y:711,width:140,height:163},CeramicRegrow:{x:0,y:782,width:176,height:162},CeramicRegrowCamo:{x:177,y:782,width:176,height:162},CeramicRegrowFortified:{x:629,y:0,width:186,height:162},CeramicRegrowFortifiedCamo:{x:629,y:163,width:186,height:162},Black:{x:1283,y:790,width:78,height:97},BlackCamo:{x:1283,y:888,width:78,height:97},BlackRegrow:{x:833,y:945,width:105,height:97},BlackRegrowCamo:{x:708,y:782,width:105,height:97},Blue:{x:1283,y:148,width:110,height:139},BlueCamo:{x:1283,y:288,width:110,height:139},BlueRegrow:{x:408,y:641,width:150,height:138},BlueRegrowCamo:{x:993,y:146,width:150,height:138},Ceramic:{x:1153,y:164,width:129,height:163},LeadFortifiedCamo:{x:993,y:875,width:133,height:156},LeadRegrow:{x:816,y:326,width:168,height:154},LeadRegrowCamo:{x:816,y:481,width:168,height:154},LeadRegrowFortified:{x:629,y:326,width:178,height:154},LeadRegrowFortifiedCamo:{x:629,y:481,width:178,height:154},Green:{x:878,y:1100,width:116,height:147},GreenCamo:{x:995,y:1100,width:116,height:147},GreenRegrow:{x:468,y:474,width:159,height:145},GreenRegrowCamo:{x:629,y:636,width:159,height:145},Lead:{x:134,y:1100,width:123,height:156},LeadCamo:{x:258,y:1100,width:123,height:156},LeadFortified:{x:0,y:1100,width:133,height:156},WhiteRegrow:{x:1153,y:1132,width:105,height:97},WhiteRegrowCamo:{x:1283,y:428,width:105,height:97},Yellow:{x:382,y:1100,width:123,height:156},YellowCamo:{x:506,y:1100,width:123,height:156},YellowRegrow:{x:816,y:636,width:168,height:154},YellowRegrowCamo:{x:0,y:945,width:168,height:154},Zebra:{x:1153,y:984,width:116,height:147},ZebraCamo:{x:1283,y:0,width:116,height:147},ZebraRegrow:{x:816,y:791,width:159,height:145},ZebraRegrowCamo:{x:993,y:0,width:159,height:145},Pink:{x:1153,y:328,width:129,height:163},PinkCamo:{x:1153,y:492,width:129,height:163},PinkRegrow:{x:354,y:782,width:176,height:162},PinkRegrowCamo:{x:531,y:782,width:176,height:162},Purple:{x:630,y:1100,width:123,height:156},PurpleCamo:{x:754,y:1100,width:123,height:156},PurpleRegrow:{x:169,y:945,width:168,height:154},PurpleRegrowCamo:{x:338,y:945,width:168,height:154},Rainbow:{x:1153,y:656,width:129,height:163},RainbowCamo:{x:1153,y:820,width:129,height:163},RainbowRegrow:{x:816,y:0,width:176,height:162},RainbowRegrowCamo:{x:816,y:163,width:176,height:162},Red:{x:1283,y:526,width:103,height:131},RedCamo:{x:1283,y:658,width:103,height:131},RedRegrow:{x:993,y:285,width:143,height:130},RedRegrowCamo:{x:993,y:416,width:143,height:130},White:{x:1283,y:986,width:78,height:97},WhiteCamo:{x:1283,y:1084,width:78,height:97},Bad:{x:0,y:238,width:326,height:235},BadFortified:{x:0,y:0,width:326,height:237},Bfb:{x:234,y:474,width:233,height:164},BfbFortified:{x:0,y:474,width:233,height:166},DdtCamo:{x:0,y:641,width:203,height:140},DdtFortifiedCamo:{x:204,y:641,width:203,height:140},Moab:{x:670,y:945,width:162,height:105},MoabFortified:{x:507,y:945,width:162,height:110},Zomg:{x:327,y:0,width:301,height:194},ZomgFortified:{x:327,y:195,width:301,height:194}};class Bloon{constructor(e,t){this.speed=bloonsData[e.replace("Camo","").replace("Regrow","").replace("Fortified","")].speed,this.scale=bloonsData[e.replace("Camo","").replace("Regrow","").replace("Fortified","")].scale,this.x=-ratioCalc(1,0,100,bloonImageMap[e].width,bloonImageMap[e].height),this.y=100+(100-100*this.scale)/2,this.type=e,this.groupIndex=t,this.width=ratioCalc(1,0,100,bloonImageMap[e].width,bloonImageMap[e].height)}move(e){this.x+=this.speed*e*6.86*speedMultiplier*roundSpeedModifier*difficultySpeedModifier}shouldDelete(){return this.x>=800}render(e){if(hiddenGroups.includes(this.groupIndex))return;let t=bloonImageMap[this.type];e.drawImage(bloons_spritesheet,t.x,t.y,t.width,t.height,this.x,this.y,this.scale*this.width,100*this.scale)}}class Blimp{constructor(e,t){this.speed=bloonsData[e.replace("Camo","").replace("Regrow","").replace("Fortified","")].speed,this.x=-1.62*bloonImageMap[e].width,this.type=e,this.groupIndex=t}move(e){this.x+=this.speed*e*6.86*speedMultiplier*roundSpeedModifier*difficultySpeedModifier}shouldDelete(){return this.x>=800}render(e){if(hiddenGroups.includes(this.groupIndex))return;let t=bloonImageMap[this.type];e.drawImage(bloons_spritesheet,t.x,t.y,t.width,t.height,this.x,150-1.62*t.height/2,1.62*t.width,1.62*t.height)}}const bloons=[];let currentRoundGroups,difficultySpeedModifier=1,roundSpeedModifier=1;const update=e=>{const t=performance.now();bloons.forEach(((t,n)=>{t.move(e),t.shouldDelete()&&bloons.splice(n,1)})),null!=currentRoundGroups&&currentRoundGroups.bloonGroups.forEach((n=>{if(t>=n.startTime&&n.count>0)if(0==n.activeTime&&(n.spawnBloon(),n.count--),n.activeTime+=e,n.spawnAccumulator+=e,0===n.spawnInterval){for(let e=0;e<n.count;e++)n.spawnBloon();n.count=0,n.spawnAccumulator=0}else for(;n.spawnAccumulator>=n.spawnInterval;){const e=Math.floor(n.spawnAccumulator/n.spawnInterval);for(let t=0;t<e;t++)n.spawnBloon(),n.count--;n.spawnAccumulator-=n.spawnInterval*e}}))},render=()=>{ctx.clearRect(0,0,canvas.width,canvas.height),bloons.forEach((e=>e.render(ctx)))};function startRound(e){if(roundSpeedModifier=calcRoundSpeed(e.roundNumber),currentRoundGroups=JSON.parse(JSON.stringify(e)),document.getElementById("roundset-reverse-checkbox").checked){let t=Math.max(...e.bloonGroups.map((e=>e.end)));for(let e of currentRoundGroups.bloonGroups){let n=e.end-e.start;e.start=t-e.end,e.end=e.start+n}}addTimelinePlayhead(Math.max(...currentRoundGroups.bloonGroups.map((e=>e.end)))/speedMultiplier),currentRoundGroups.bloonGroups.forEach(((e,t)=>{e.startTime=performance.now()+1e3*e.start/speedMultiplier,e.activeTime=0,e.spawnAccumulator=0,e.spawnInterval=(e.end-e.start)/(e.count-1)/speedMultiplier,isFinite(e.spawnInterval)||(e.spawnInterval=0),e.spawnBloon=spawnBloon(e,t)}))}function spawnBloon(e,t){return function(){let n=e.bloon,d=["Moab","MoabFortified","Bfb","BfbFortified","Zomg","ZomgFortified","DdtCamo","DdtFortifiedCamo","Bad","BadFortified"].includes(n)?new Blimp(n,t):new Bloon(n,t),o=bloonsData[n.replace("Camo","").replace("Regrow","").replace("Fortified","")].layer,s=bloons.findIndex((e=>bloonsData[e.type.replace("Camo","").replace("Regrow","").replace("Fortified","")].layer>o));-1===s?bloons.push(d):bloons.splice(s,0,d)}}function calcRoundSpeed(e){let t=0;return t=e<=80?1:e<=100?1+.02*(e-80):e<=150?1.6+.02*(e-101):e<=200?3+.02*(e-151):e<=250?4.5+.02*(e-201):6+.02*(e-252),t}let readyFlags=[0,0,0,0,0],pressedStart=!1,timerInterval=null,constants={},locJSON={},achievementsJSON={},achievementsHelper={},trophyStoreItemsJSON={},teamsStoreItemsJSON={},rogueJSON={},backQueue=[],backButton=createEl("img",{src:"../Assets/UI/BackBtn.webp",classList:["back-button","pointer"]});function goBack(){let e=backQueue.pop();e.source&&(document.getElementById(e.destination+"-content").style.display="none",document.getElementById(e.source+"-content").style.display="flex"),e.callback&&e.callback(),timerInterval&&clearInterval(timerInterval),changeHexBGColor(constants.BGColor),0===backQueue.length&&backButton.classList.remove("visible"),resetScroll()}function addToBackQueue(e){backQueue.push(e),backButton.classList.add("visible")}function clearBackQueue(){backQueue=[],backButton.classList.remove("visible")}function createEl(e,t={}){const n=document.createElement(e);if(t.classList&&n.classList.add(...t.classList),t.innerHTML&&(n.innerHTML=t.innerHTML),t.textContent&&(n.textContent=t.textContent),t.id&&(n.id=t.id),t.src&&(n.src=t.src),t.placeholder&&(n.placeholder=t.placeholder),t.style&&Object.assign(n.style,t.style),t.onclick&&(n.onclick=t.onclick),t.attributes)for(const[e,d]of Object.entries(t.attributes))n.setAttribute(e,d);return t.children&&t.children.forEach((e=>n.appendChild(e))),n}function createModal({header:e="",content:t="",footer:n="",classList:d=[]}={}){const o=createEl("div",{classList:["modal-overlay",...d]}),s=createEl("div",{classList:["modal-box"]}),a=createEl("div",{classList:["modal-header"]});""!=e&&s.appendChild(a);const r=createEl("div",{classList:["collection-header-modal-left"]});a.appendChild(r);const i=createEl("p",{classList:["collection-modal-header-text","black-outline"],innerHTML:e});a.appendChild(i);const l=createEl("img",{classList:["collection-modal-close","pointer"],src:"./Assets/UI/CloseBtn.webp"});l.addEventListener("click",(()=>{goBack()})),a.appendChild(l);const c=createEl("div",{classList:["modal-content"]});if(s.appendChild(c),"string"==typeof t?c.innerHTML=t:t&&c.appendChild(t),n){const e=createEl("div",{classList:["modal-footer"]});"string"==typeof n?e.innerHTML=n:e.appendChild(n),s.appendChild(e)}o.appendChild(s),document.body.appendChild(o),addToBackQueue({callback:closeModal})}function closeModal(){document.querySelector(".modal-overlay")?.remove()}function showLoading(){let e=0;function t(){e--,0===e&&(document.getElementById("loading").style.transform="scale(0)")}new MutationObserver((n=>{n.forEach((n=>{"childList"===n.type&&n.addedNodes.forEach((n=>{"IMG"===n.nodeName&&(e++,n.addEventListener("load",t),n.addEventListener("error",t))}))}))})).observe(document.body,{childList:!0,subtree:!0}),document.getElementById("loading").style.removeProperty("transform")}function hideLoading(){document.getElementById("loading").style.transform="scale(0)"}function fetchConstants(){return fetch("./data/Constants.json").then((e=>e.json())).then((e=>{constants=e,readyFlags[4]=1})).catch((e=>{console.error("Error:",e),errorModal(e,"js")}))}function fetchLocKeys(){return fetch("./data/English.json").then((e=>e.json())).then((e=>{locJSON=e}))}async function fetchRogueDependencies(){return await fetchLocKeys(),fetch("./data/rogueData.json").then((e=>e.json())).then((e=>{rogueJSON=e,postProcessRogueData()})).catch((e=>{console.error("Error:",e),errorModal(e,"js")}))}async function fetchInstaDependencies(){await fetchLocKeys(),generateStats(),generateInstaData(),changeProgressTab("InstaMonkeys"),clearBackQueue(),hideLoading()}async function fetchMainDependencies(){await fetchLocKeys(),await fetchRogueDependencies(),Promise.all([fetch("./data/Achievements150.json").then((e=>e.json())),fetch("./data/trophyStoreItems.json").then((e=>e.json())),fetch("./data/teamsStoreItems.json").then((e=>e.json()))]).then((([e,t,n])=>{achievementsJSON=e,trophyStoreItemsJSON=t,teamsStoreItemsJSON=n,readyFlags[2]=1,readyFlags[3]=1,loadSettings(),generateIfReady()})).catch((e=>{console.error("Error:",e),errorModal(e,"js")})),showLoading()}function resetScroll(){document.body.scrollTop=0,document.documentElement.scrollTop=0}function loadSettings(){let e=JSON.parse(localStorage.getItem("BTD6OAKSettings"));e&&(preventRateLimiting=e.ProfileLoading,useNamedMonkeys=e.UseNamedMonkeys,showTeamsItems=e.TeamsStoreItems)}function saveSettings(){let e={ProfileLoading:preventRateLimiting,UseNamedMonkeys:useNamedMonkeys,TeamsStoreItems:showTeamsItems};localStorage.setItem("BTD6OAKSettings",JSON.stringify(e))}function generateAvatar(e,t){let n=document.createElement("div");n.style.width=`${e}px`,n.style.height=`${e}px`,n.classList.add("avatar");let d=document.createElement("img");d.classList.add("avatar-frame","noSelect"),d.style.width=`${e}px`,d.src="../Assets/UI/InstaTowersContainer.webp",n.appendChild(d);let o=document.createElement("img");return o.classList.add("avatar-img","noSelect"),o.style.width=`${e}px`,o.src=t,n.appendChild(o),n}function openBTD6Link(e){window.location.href=e}function openBTD6Site(e){window.open(e,"_blank")}function copyLoadingIcon(e){let t=document.getElementsByClassName("loading-icon")[0].cloneNode(!0);t.classList.add("loading-icon-leaderboard"),t.style.height="unset",e.appendChild(t)}function formatTime(e){return[Math.floor(e/3600),Math.floor(e%3600/60),Math.floor(e%60)].map((e=>e<10?"0"+e:e)).join(":")}function formatScoreTime(e){let t=Math.floor(e/1e3),n=e%1e3,d=Math.floor(t/3600);t%=3600;let o=Math.floor(t/60),s=t%60;o=o.toString().padStart(2,"0"),s=s.toString().padStart(2,"0"),n=n.toString().padStart(3,"0");let a=`${o}:${s}.${n}`;return d>0&&(d=d.toString().padStart(2,"0"),a=`${d}:${a}`),a}function getRemainingTime(e){return(e-new Date)/1e3}function updateTimer(e,t){const n=getRemainingTime(e),d=document.getElementById(t);if(n>172800){const e=Math.ceil(n/86400);d.textContent=`${e} days left`,d.style.width="130px"}else n<0?(d.textContent="Finished",d.style.textAlign="right"):(d.style.width="100px",d.textContent=formatTime(n))}function relativeTime(e,t){const n=[{name:"year",ms:31536e6},{name:"month",ms:2592e6},{name:"day",ms:864e5},{name:"hour",ms:36e5},{name:"minute",ms:6e4},{name:"second",ms:1e3}],d=e-t;for(const e of n){if(d<e.ms)continue;let t=Math.round(d/e.ms);return`${t} ${e.name}${t>1?"s":""} ago`}}function changeHexBGColor(e){null!=e?document.body.style.backgroundColor=`rgb(${255*e[0]},${255*e[1]},${255*e[2]})`:document.body.style.removeProperty("background-color")}function ratioCalc(e,t,n,d,o){switch(e){case 1:return n*(d/o);case 2:return t*(o/d);case 3:return o*(t/n);case 4:return d*(n/t)}}function processRewardsString(e){let t={},n=e.split("#"),d=0;for(let e of n){t[d]={};let n=e.split(":"),o=n[0];if(!["MonkeyMoney","Power","InstaMonkey","KnowledgePoints","RandomInstaMonkey","Trophy"].includes(o)){t[d].type="Other",t[d].value=o,d++;continue}let s=n[1].split(",");switch(o){case"MonkeyMoney":t[d].type="MonkeyMoney",t[d].amount=parseInt(s[0]);break;case"Power":t[d].type="Power",t[d].power=s[0],t[d].amount=parseInt(s[1]),null==s[1]&&(t[d].amount=1);break;case"InstaMonkey":t[d].type="InstaMonkey",t[d].tower=s[0],t[d].tiers=s[1];break;case"KnowledgePoints":t[d].type="KnowledgePoints",t[d].amount=parseInt(s[0]);break;case"RandomInstaMonkey":t[d].type="RandomInstaMonkey",t[d].tier=s[0],t[d].amount=parseInt(s[1]);break;case"Trophy":t[d].type="Trophy",t[d].trophy=s[0]}d++}return t}function generateLoginDiv(e){let t=createEl("div",{classList:["d-flex","ai-center","jc-center","fd-column","bg-color-primary"]}),n=createEl("p",{classList:["site-info-header","black-outline"],innerHTML:"Login with your OAK Token!"});t.appendChild(n);const d=createEl("div");Object.entries(localStorageOAK).forEach((([t,n])=>{const o=createEl("div",{classList:["previous-oak-entry","d-flex","ai-center","ps-relative"],style:{backgroundImage:`linear-gradient(to right, transparent 80%, var(--profile-primary) 100%),url(${n.banner})`}});o.appendChild(generateAvatar(100,n.avatar)),o.appendChild(createEl("p",{classList:["profile-name","tc-white","font-luckiest","black-outline"],innerHTML:n.displayName}));const s=createEl("img",{classList:["use-button","ps-absolute"],src:"./Assets/UI/ContinueBtn.webp"});s.addEventListener("click",(async()=>{pressedStart||(pressedStart=!0,document.getElementById("loading").style.removeProperty("transform"),oak_token=t,await getSaveData(t),loggedIn=!0,e?e(oak_token):fetchMainDependencies())})),o.appendChild(s);const a=createEl("img",{classList:["delete-button","ps-absolute"],src:"./Assets/UI/CloseBtn.webp"});a.addEventListener("click",(()=>{delete localStorageOAK[t],writeLocalStorage(),d.removeChild(o)})),o.appendChild(a),d.appendChild(o)})),t.appendChild(d);let o=document.createElement("div");o.classList.add("site-access-div"),t.appendChild(o);let s=document.createElement("div");s.classList.add("oak-entry-div"),t.appendChild(s);let a=document.createElement("input");a.classList.add("key-entry"),a.placeholder="Enter your OAK here",s.appendChild(a);let r=document.createElement("div");r.classList.add("start-button","black-outline"),r.innerHTML="Start",r.addEventListener("click",(async()=>{let e=a.value;e.length<5||e.length>30||!e.startsWith("oak_")?errorModal('Please enter a valid OAK! This will start with "oak_".'):pressedStart||(document.getElementById("loading").style.removeProperty("transform"),pressedStart=!0,loggedIn=!0,oak_token=a.value,await getSaveData(oak_token),fetchMainDependencies())})),s.appendChild(r);let i=document.createElement("div");i.classList.add("get-oak-div"),t.appendChild(i);let l=document.createElement("p");l.classList.add("where-text"),l.innerHTML="Don't have an OAK token? Read here:",i.appendChild(l);let c=document.createElement("p");c.classList.add("where-button","black-outline"),c.style.width="220px",c.innerHTML="View OAK Guide",c.addEventListener("click",(()=>{openOAKInstructionsModal()})),i.appendChild(c);let u=document.createElement("div");return u.id="oak-instructions-div",u.classList.add("oak-instructions-div"),u.style.display="none",t.appendChild(u),t}function openOAKInstructionsModal(){let e=createEl("div",{style:{padding:"10px"}});return e.appendChild(createEl("p",{classList:["oak-instructions-header","black-outline"],innerHTML:"What is an Open Access Key?"})),e.appendChild(createEl("p",{classList:["oak-instructions-text"],innerHTML:"An Open Access Key (OAK) is a unique key that allows you to access your Bloons TD 6 data from Ninja Kiwi's Open Data API. The site will use this to fetch your information from the API to be displayed in a familiar way. <br><br>NOTE: Progress tracking is not available for BTD6+ on Apple Arcade and BTD6 Netflix as OAK tokens are unavailable."})),e.appendChild(createEl("p",{classList:["oak-instructions-header","black-outline"],innerHTML:"How do I get one?"})),e.appendChild(createEl("p",{classList:["oak-instructions-text"],innerHTML:"Step 1: Login and Backup your progress with a Ninja Kiwi Account in BTD6. You can do this by going to settings from the main menu and clicking on the Account button."})),e.appendChild(createEl("img",{classList:["oak-instruction-img"],src:"./Assets/UI/OAKTutorial1.webp"})),e.appendChild(createEl("p",{classList:["oak-instructions-text"],innerHTML:'Step 2: Select "Open Data API" at the bottom right of the account screen.'})),e.appendChild(createEl("img",{classList:["oak-instruction-img"],src:"./Assets/UI/OAKTutorial2.webp"})),e.appendChild(createEl("p",{classList:["oak-instructions-text"],innerHTML:'Step 3: Generate a key and copy that in to the above text field. It should start with "oak_". Then click "Start" to begin!'})),e.appendChild(createEl("img",{classList:["oak-instruction-img"],src:"./Assets/UI/OAKTutorial3.webp"})),e.appendChild(createEl("p",{classList:["oak-instructions-text"],innerHTML:'You can read more about the Open Data API here: <a href="https://ninja.kiwi/opendatafaq" target="_blank", style="color:white";>Open Data API Article</a><br><br>Privacy Note: This app does not store any data being sent to or retrieved from Ninja Kiwi\'s Open Data API outside of your browser/device. The localStorage browser feature is used to prevent users from having to re-enter their OAK token every time they visit the site. If you would like to delete this stored data, you can do so by clicking the "X" on the profile you would like to delete on this homepage or clearing your browsing data.'})),createModal({header:"OAK Instructions",content:e}),e}function errorModal(e,t,n){if(isErrorModalOpen&&!n)return;let d=document.createElement("div");d.classList.add("error-modal-overlay"),document.body.appendChild(d);let o=document.createElement("div");o.id="error-modal",o.classList.add("error-modal"),d.appendChild(o);let s=document.createElement("div");s.id="error-modal-header",s.classList.add("error-modal-header"),o.appendChild(s);let a=document.createElement("img");a.id="error-modal-header-img",a.classList.add("error-modal-header-img"),a.src="./Assets/UI/BadConnectionBtn.webp",s.appendChild(a);let r=document.createElement("p");r.classList.add("error-modal-header-text","black-outline"),r.innerHTML="Error",s.appendChild(r);let i=document.createElement("div");i.classList.add("error-modal-dummy"),s.appendChild(i);let l=document.createElement("div");l.id="error-modal-content",l.classList.add("error-modal-content"),l.innerHTML=""+e,o.appendChild(l);let c=document.createElement("div");if(c.classList.add("error-modal-content"),"Invalid user ID / Player Does not play this game"===e)c.innerHTML="Please try again or create a new Open Access Key.",o.appendChild(c);if("ratelimit"==t){let e=document.createElement("div");e.classList.add("error-toggle-div"),o.appendChild(e);let t=document.createElement("p");t.classList.add("maps-progress-coop-toggle-text","black-outline"),t.innerHTML="Manually Load Profiles: ",e.appendChild(t);let n=document.createElement("input");n.classList.add("maps-progress-coop-toggle-input"),n.type="checkbox",n.checked=preventRateLimiting,n.addEventListener("change",(()=>{n.checked?preventRateLimiting=!0:preventRateLimiting=!1})),e.appendChild(n)}let u=document.createElement("div");u.classList.add("error-modal-ok-button-div"),o.appendChild(u);let p=document.createElement("div");p.classList.add("start-button","modal-ok-button","black-outline"),p.innerHTML="OK",p.addEventListener("click",(()=>{isErrorModalOpen=!1,document.body.removeChild(d)})),u.appendChild(p);let m=document.createElement("img");m.classList.add("error-modal-close"),m.src="./Assets/UI/CloseBtn.webp",m.addEventListener("click",(()=>{isErrorModalOpen=!1,document.body.removeChild(d)})),l.appendChild(m),isErrorModalOpen=!0}backButton.addEventListener("click",(()=>{goBack()})),document.querySelector(".header").prepend(backButton);const rtf=new Intl.RelativeTimeFormat("en",{style:"long"});function getRelativeTimeString(e){const t=e-Date.now(),n=Math.abs(t),d=36e5,o=24*d;let s,a;return n>=o?(s=Math.round(t/o),a="day"):n>=d?(s=Math.round(t/d),a="hour"):(s=Math.round(t/6e4),a="minute"),rtf.format(s,a)}